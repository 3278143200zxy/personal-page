<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>作品详情</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  .topbar {
    position:fixed;top:0;left:0;right:0;height:60px;
    background:#000;display:flex;align-items:center;padding-left:25px;
    font-weight:600;border-bottom:1px solid #111;z-index:9999;
  }
  .topbar a img {
    height:48px;width:auto;cursor:pointer;
  }
  body {
    font-family: Arial, sans-serif;
    background:#222;color:#eee;
    padding-top:60px;
    max-width:700px;margin:0 auto;
    padding-left:15px;padding-right:15px;
  }
  h1 {
    font-size:3em;margin:15px 0 10px;text-align:left;text-transform:none;
  }
  .gallery-container {
    width:100%;height:420px;background:#000;
    margin:15px auto;position:relative;overflow:hidden;
  }
  .gallery-image,.gallery-video {
    width:100%;height:100%;object-fit:contain;
    background:#000;display:block;user-select:none;
  }
  #loading-overlay {
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    color:#fff;font-size:1.5em;font-weight:700;user-select:none;
    pointer-events:none;display:none;z-index:25;
  }
  .arrow {
    position:absolute;top:50%;transform:translateY(-50%);
    font-size:40px;color:#fff;cursor:pointer;padding:10px;
    user-select:none;z-index:20;background:rgba(0,0,0,0.3);
    border-radius:50%;transition:background-color .3s;
  }
  .arrow:hover {
    background:rgba(255,255,255,0.3);color:#ccc;
  }
  .left-arrow { left:10px; }
  .right-arrow { right:10px; }

  .thumbs-wrapper {
    position:relative;margin:12px auto 0;
    width:600px;height:65px;user-select:none;overflow:hidden;
  }
  .thumbs-mask-left, .thumbs-mask-right {
    position:absolute;top:0;width:50px;height:65px;
    pointer-events:none;z-index:30;
  }
  .thumbs-mask-left {
    left:0;background:linear-gradient(to right,#222 0%,transparent 100%);
  }
  .thumbs-mask-right {
    right:0;background:linear-gradient(to left,#222 0%,transparent 100%);
  }

  .thumbs-track {
    display:flex;gap:8px;height:65px;will-change:transform;
    transition: transform 0.35s ease;
  }

  .thumb {
    position:relative;
    width:80px;height:45px;
    background:#000 no-repeat center/cover;
    border:2px solid transparent;border-radius:4px;
    cursor:pointer;flex-shrink:0;
  }
  .thumb.video-thumb::after {
    content:"▶";
    position:absolute;top:50%;left:50%;
    transform:translate(-50%,-50%);
    font-size:24px;color:rgba(255,255,255,0.8);
    pointer-events:none;
  }
  .thumb.selected { border-color:#fff; }

  p.description {
    font-size:1.1em;line-height:1.5;white-space:pre-wrap;margin-top:15px;
  }
  .back-link {
    margin-top:30px;display:inline-block;color:#aaf;
    text-decoration:underline;cursor:pointer;
  }

  /* 白框（固定中间） */
  #thumb-selected-box {
    position:absolute;
    top:0;
    width:80px;
    height:45px;
    border:2px solid white;
    border-radius:4px;
    pointer-events:none;
    z-index:40;
    left:260px; /* 600宽，居中= (600-80)/2 = 260 */
  }
</style>
</head>
<body>

<div class="topbar">
  <a href="index.html"><img src="logo.png" alt="logo" /></a>
</div>

<div class="gallery-container">
  <div id="loading-overlay">Loading...</div>
  <div class="arrow left-arrow" onclick="prevImage()">❮</div>
  <img id="gallery-img" class="gallery-image" src="" alt="作品图片" draggable="false" style="display:none;" />
  <video id="gallery-video" class="gallery-video" controls style="display:none;"></video>
  <div class="arrow right-arrow" onclick="nextImage()">❯</div>
</div>

<div class="thumbs-wrapper" id="thumbs-wrapper">
  <div class="thumbs-mask-left"></div>
  <div class="thumbs-mask-right"></div>
  <div class="thumbs-track" id="thumbs-track"></div>
  <div id="thumb-selected-box"></div>
</div>

<h1 id="title">加载中...</h1>
<p class="description" id="description"></p>
<a href="index.html" class="back-link">← 返回作品集</a>

<script>
const THUMB_W = 80, THUMB_GAP = 8;
const STEP_PX = THUMB_W + THUMB_GAP;

let folderName = "", galleryImages = [], galleryIndex = 0;
let thumbsTrack, thumbsWrapper, selectedBox;
let thumbsIndexes = [];
let currentPos = 0;

let isTransitioning = false;

function getQueryParam(p){return new URLSearchParams(location.search).get(p);}

async function loadInfo(folder){
  folderName = folder || "";
  if(!folder){
    setError("未指定作品文件夹","请从主页点击作品进入详情页面。");
    return;
  }
  try{
    let res = await fetch(`content/${folder}/info.json`);
    if(!res.ok) throw "未找到 info.json";
    let info = await res.json();

    document.getElementById('title').textContent = info.title || folder;

    let d = info.description || "无描述内容";
    d = d.split("\n").slice(1).join("\n");
    document.getElementById('description').textContent = d;

    galleryImages = info.gallery || [];

    if(galleryImages.length>0){
      galleryIndex = 0;
      thumbsTrack = document.getElementById('thumbs-track');
      thumbsWrapper = document.getElementById('thumbs-wrapper');
      selectedBox = document.getElementById('thumb-selected-box');

      setupThumbnails();
      showMedia();
    }
    else clearMedia();
  }
  catch(e){
    setError("加载失败",`无法加载作品信息：${e}`);
  }
}

function setError(title,text){
  document.getElementById('title').textContent=title;
  document.getElementById('description').textContent=text;
  clearMedia();
}

function clearMedia(){
  document.getElementById('gallery-img').style.display='none';
  document.getElementById('gallery-video').style.display='none';
  document.getElementById('loading-overlay').style.display='none';
  if(thumbsTrack) thumbsTrack.innerHTML='';
}

function showLoading(){
  document.getElementById('loading-overlay').style.display='block';
  document.getElementById('gallery-img').style.display='none';
  document.getElementById('gallery-video').style.display='none';
}
function hideLoading(){document.getElementById('loading-overlay').style.display='none';}

function showMedia(){
  if(!galleryImages.length) return;
  const img = document.getElementById('gallery-img');
  const video = document.getElementById('gallery-video');

  const src = galleryImages[galleryIndex].startsWith('content/')
    ? galleryImages[galleryIndex]
    : `content/${folderName}/gallery/${galleryImages[galleryIndex]}`;

  showLoading();

  if(src.toLowerCase().endsWith('.mp4')){
    img.style.display='none';
    video.style.display='block';
    video.src = src;
    video.load();
    video.play().catch(()=>{});
    video.oncanplay = ()=> hideLoading();
    video.onerror = ()=> hideLoading();
  }else{
    video.pause();
    video.style.display='none';
    img.style.display='block';
    img.onload = ()=> hideLoading();
    img.onerror = ()=> hideLoading();
    img.src = src;
  }
}

/*==========================
  1. 初始化缩略图（内容重复3次）
==========================*/
function setupThumbnails(){
  thumbsTrack.innerHTML = '';
  thumbsIndexes = [];

  const total = galleryImages.length;

  // ★★★关键：重复3份用于无限循环★★★
  for(let i=0;i<3;i++){
    for(let j=0;j<total;j++){
      thumbsIndexes.push(j);
    }
  }

  thumbsIndexes.forEach((realIndex,pos)=>{
    const div = document.createElement('div');
    div.className='thumb';
    div.dataset.realIndex = realIndex;
    div.dataset.pos = pos;

    const path = galleryImages[realIndex];
    if(path.toLowerCase().endsWith('.mp4')){
      div.classList.add('video-thumb');
      generateVideoThumbnail(
        path.startsWith('content/')?path:`content/${folderName}/gallery/${path}`
      ).then(url=>{
        if(url) div.style.backgroundImage = `url(${url})`;
      });
    }else{
      div.style.backgroundImage = 
        `url(${path.startsWith('content/')?path:`content/${folderName}/gallery/${path}`})`;
    }

    div.onclick = ()=>{
      galleryIndex = realIndex;
      showMedia();
      jumpTo(pos);
    };

    thumbsTrack.appendChild(div);
  });

  currentPos = total + galleryIndex; // 初始在中间段
  jumpTo(currentPos,true);
}

/*==========================
  2. 核心：无缝跳转到某个位置
==========================*/
function jumpTo(pos, noAnim=false){
  const total = galleryImages.length;
  const totalThumbs = thumbsTrack.childElementCount;

  // 强制位于三份当中间那份
  let ideal = pos;
  if(ideal < total) ideal += total;
  if(ideal >= 2*total) ideal -= total;

  currentPos = ideal;

  // 偏移量：让当前项在“白框正中位置”
  let offset = (currentPos * STEP_PX) - 260; // 260是白框左边位置

  thumbsTrack.style.transition = noAnim ? 'none' : 'transform 0.35s ease';
  thumbsTrack.style.transform = `translateX(${-offset}px)`;
}

/*==========================
  3. 左/右移动（无限循环）
==========================*/
function move(step){
  if(isTransitioning) return;
  isTransitioning = true;

  const total = galleryImages.length;

  currentPos += step;

  // 超出边界后仍会被 jumpTo 自动修复
  jumpTo(currentPos);

  galleryIndex = thumbsIndexes[currentPos];

  showMedia();

  setTimeout(()=>{
    isTransitioning=false;
  },350);
}

function nextImage(){ move(1); }
function prevImage(){ move(-1); }

/*==========================
  4. 视频缩略图
==========================*/
function generateVideoThumbnail(url){
  return new Promise(resolve=>{
    const v=document.createElement('video');
    v.src=url;
    v.crossOrigin="anonymous";
    v.muted=true;
    v.playsInline=true;
    v.currentTime=0.1;
    v.addEventListener('loadeddata',()=>{
      const c=document.createElement('canvas');
      c.width=v.videoWidth;c.height=v.videoHeight;
      c.getContext('2d').drawImage(v,0,0,c.width,c.height);
      resolve(c.toDataURL('image/png'));
    },{once:true});
    v.onerror=()=>resolve(null);
  });
}

window.onload = ()=>loadInfo(getQueryParam('folder'));
</script>

</body>
</html>
