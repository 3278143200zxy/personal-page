<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>作品详情</title>
<style>
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    background: #222;
    color: #eee;
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 60px auto 30px;
    padding: 0 15px;
  }
  h1 {
    font-size: 3em;
    margin-bottom: 10px;
    text-align: left;
  }
  .gallery-container {
    position: relative;
    width: 100%;
    height: 420px;
    background: black;
    overflow: hidden;
    margin-bottom: 15px;
  }
  #loading-overlay {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 1.5em;
    display: none;
    pointer-events: none;
    z-index: 30;
  }
  img.gallery-image, video.gallery-video {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: none;
    user-select: none;
    background: black;
  }
  .arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 40px;
    color: white;
    cursor: pointer;
    padding: 10px;
    background: rgba(0,0,0,0.3);
    border-radius: 50%;
    user-select: none;
    z-index: 40;
    transition: background-color 0.3s;
  }
  .arrow:hover {
    background: rgba(255,255,255,0.3);
    color: #ccc;
  }
  .left-arrow { left: 10px; }
  .right-arrow { right: 10px; }

  /* 缩略图容器和滑动条 */
  .thumbs-wrapper {
    position: relative;
    width: 600px;
    height: 65px;
    margin: 0 auto;
    overflow: hidden;
    user-select: none;
  }
  .thumbs-track {
    display: flex;
    gap: 8px;
    height: 65px;
    will-change: transform;
    transition: transform 0.4s ease;
    position: relative;
  }
  .thumb {
    position: relative;
    flex-shrink: 0;
    width: 80px;
    height: 45px;
    border-radius: 4px;
    background: black;
    cursor: pointer;
    object-fit: cover;
  }

  /* 播放按钮SVG容器 */
  .thumb.video-thumb {
    position: relative;
  }
  .thumb.video-thumb svg.play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 24px;
    height: 24px;
    fill: white;
    filter: drop-shadow(0 0 2px black);
    pointer-events: none;
  }

  /* 白框随缩略图一起移动 */
  .selection-box {
    pointer-events: none;
    position: absolute;
    top: 10px;
    width: 80px;
    height: 45px;
    border: 2px solid white;
    border-radius: 4px;
    box-sizing: border-box;
    z-index: 50;
    transition: left 0.4s ease;
  }

  p.description {
    white-space: pre-wrap;
    font-size: 1.1em;
    line-height: 1.5;
    margin-top: 15px;
  }
  .back-link {
    margin-top: 30px;
    display: inline-block;
    color: #aaf;
    text-decoration: underline;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1 id="title">加载中...</h1>

<div class="gallery-container">
  <div id="loading-overlay">Loading...</div>
  <div class="arrow left-arrow" onclick="prevImage()">❮</div>
  <img id="gallery-img" class="gallery-image" draggable="false" alt="作品图片" />
  <video id="gallery-video" class="gallery-video" controls></video>
  <div class="arrow right-arrow" onclick="nextImage()">❯</div>
</div>

<div class="thumbs-wrapper">
  <div class="thumbs-track" id="thumbs-track">
    <div class="selection-box"></div>
  </div>
</div>

<p class="description" id="description"></p>

<a href="index.html" class="back-link">← 返回作品集</a>

<script>
  const titleEl = document.getElementById('title');
  const descEl = document.getElementById('description');
  const galleryImg = document.getElementById('gallery-img');
  const galleryVideo = document.getElementById('gallery-video');
  const loadingOverlay = document.getElementById('loading-overlay');
  const thumbsTrack = document.getElementById('thumbs-track');
  const selectionBox = document.querySelector('.selection-box');

  const THUMB_WIDTH = 80;
  const THUMB_GAP = 8;
  const THUMBS_VISIBLE_COUNT = 6;
  const STEP = THUMB_WIDTH + THUMB_GAP;

  let folder = getQueryParam('folder');
  let gallery = [];
  let currentIndex = 0;

  // 缓存视频缩略图Base64
  const videoThumbCache = {};

  function getQueryParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  async function fetchInfo() {
    if (!folder) {
      showError("未指定作品文件夹", "请从主页点击作品进入详情页面。");
      return;
    }
    try {
      const res = await fetch(`content/${folder}/info.json`);
      if (!res.ok) throw new Error("找不到 info.json");
      const info = await res.json();
      titleEl.textContent = info.title || folder;
      descEl.textContent = info.description || "";
      gallery = info.gallery || [];
      if (!gallery.length) {
        showError("无画廊内容", "");
        return;
      }
      currentIndex = 0;
      await renderThumbnails();
      showCurrentMedia();
    } catch (e) {
      showError("加载失败", `无法加载作品信息：${e.message}`);
    }
  }

  function showError(title, desc) {
    titleEl.textContent = title;
    descEl.textContent = desc;
    galleryImg.style.display = 'none';
    galleryVideo.style.display = 'none';
    loadingOverlay.style.display = 'none';
    thumbsTrack.innerHTML = '';
  }

  function showLoading() {
    loadingOverlay.style.display = 'block';
    galleryImg.style.display = 'none';
    galleryVideo.style.display = 'none';
  }

  function hideLoading() {
    loadingOverlay.style.display = 'none';
  }

  async function renderThumbnails() {
    thumbsTrack.innerHTML = '';
    thumbsTrack.appendChild(selectionBox); // 重新插入白框，防止丢失

    const len = gallery.length;
    const totalThumbs = len * 3;

    for (let i = 0; i < totalThumbs; i++) {
      const realIndex = i % len;
      const src = gallery[realIndex];
      const thumb = document.createElement('img');
      thumb.classList.add('thumb');
      thumb.dataset.index = realIndex;

      if (src.toLowerCase().endsWith('.mp4')) {
        thumb.classList.add('video-thumb');
        thumb.src = await getVideoThumbnail(`content/${folder}/gallery/${src}`);
        const svgNS = "http://www.w3.org/2000/svg";
        const playIcon = document.createElementNS(svgNS, "svg");
        playIcon.setAttribute("viewBox", "0 0 24 24");
        playIcon.classList.add('play-icon');
        const polygon = document.createElementNS(svgNS, "polygon");
        polygon.setAttribute("points", "8,5 19,12 8,19");
        playIcon.appendChild(polygon);
        thumb.appendChild(playIcon);
      } else {
        thumb.src = src.startsWith('content/') ? src : `content/${folder}/gallery/${src}`;
      }

      thumb.alt = `缩略图 ${realIndex + 1}`;
      thumb.onclick = () => {
        currentIndex = realIndex;
        updateThumbsPosition();
        showCurrentMedia();
      };

      thumbsTrack.appendChild(thumb);
    }
    updateThumbsPosition(false);
  }

  function updateThumbsPosition(withTransition = true) {
    const len = gallery.length;
    let currentPos = len + currentIndex;
    const translateX = -STEP * (currentPos - Math.floor(THUMBS_VISIBLE_COUNT / 2));

    thumbsTrack.style.transition = withTransition ? 'transform 0.4s ease' : 'none';
    thumbsTrack.style.transform = `translateX(${translateX}px)`;

    // 白框随thumbs-track移动，left设为当前缩略图相对thumbs-track的位置
    const leftPos = currentPos * STEP;
    selectionBox.style.transition = withTransition ? 'left 0.4s ease' : 'none';
    selectionBox.style.left = `${leftPos}px`;
  }

  async function showCurrentMedia() {
    if (!gallery.length) return;
    showLoading();

    const path = gallery[currentIndex];
    const src = path.startsWith('content/') ? path : `content/${folder}/gallery/${path}`;

    if (src.toLowerCase().endsWith('.mp4')) {
      galleryImg.style.display = 'none';
      galleryVideo.style.display = 'block';
      galleryVideo.src = src;
      galleryVideo.load();
      try {
        await galleryVideo.play();
      } catch {}
      galleryVideo.oncanplay = () => hideLoading();
      galleryVideo.onerror = () => hideLoading();
    } else {
      galleryVideo.pause();
      galleryVideo.style.display = 'none';
      galleryImg.style.display = 'block';
      galleryImg.src = src;
      galleryImg.alt = `作品图片 ${currentIndex + 1}`;
      galleryImg.onload = () => hideLoading();
      galleryImg.onerror = () => hideLoading();
    }
  }

  function nextImage() {
    if (!gallery.length) return;
    currentIndex = (currentIndex + 1) % gallery.length;
    updateThumbsPosition();
    showCurrentMedia();
  }

  function prevImage() {
    if (!gallery.length) return;
    currentIndex = (currentIndex - 1 + gallery.length) % gallery.length;
    updateThumbsPosition();
    showCurrentMedia();
  }

  function getVideoThumbnail(videoUrl) {
    return new Promise((resolve) => {
      if (videoThumbCache[videoUrl]) {
        resolve(videoThumbCache[videoUrl]);
        return;
      }
      const video = document.createElement('video');
      video.src = videoUrl;
      video.crossOrigin = "anonymous";
      video.muted = true;
      video.playsInline = true;
      video.preload = "auto";
      video.currentTime = 0.1;

      video.addEventListener('loadeddata', () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = THUMB_WIDTH;
        canvas.height = 45;

        const vw = video.videoWidth;
        const vh = video.videoHeight;
        const aspectVideo = vw / vh;
        const aspectCanvas = canvas.width / canvas.height;

        let sx = 0, sy = 0, sWidth = vw, sHeight = vh;

        if (aspectVideo > aspectCanvas) {
          sWidth = vh * aspectCanvas;
          sx = (vw - sWidth) / 2;
        } else {
          sHeight = vw / aspectCanvas;
          sy = (vh - sHeight) / 2;
        }

        ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);

        const dataUrl = canvas.toDataURL('image/png');
        videoThumbCache[videoUrl] = dataUrl;
        resolve(dataUrl);
      });

      video.addEventListener('error', () => {
        resolve('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAAAyCAIAAAAsyk63AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAM1JREFUeNrs0jEOgCAMBNCf//7XUE0nkPWHl6M7ZgK0xDrFy1QI7Pzso0QCd3+1CMABq2s3jCOBTL1Fo6Xk1yYyoMaLtrFkCWxmVDQhPMNY4DzOfzMYiDQGRl6TiCHTDIPFo4QqlhP2QxIAXAaUMVb8nJtwZwd1jo6U4J6AQ14KN7BqPLKoUifTiRE5YxNoI0EHi0gAKAD7xGr9U9MrHsAAAAASUVORK5CYII=');
      });

      video.play().then(() => video.pause()).catch(() => {});
    });
  }

  fetchInfo();
</script>
</body>
</html>
